---
import { ClientRouter } from "astro:transitions";
import { localeSlugs } from "../../site.config";
import { getFullLocale, parseLocale, getNameFromLocale } from "../../utils/i18n";
import { resolvePath } from "astro-loader-i18n";
import { useI18n } from "astro-nanostores-i18n:runtime";
import { params } from "@nanostores/i18n";

type Props = {
  translations?: Record<string, string>;
};

const messages = useI18n("layouts.head", {
  title: "Robins Blog",
  filteredByLanguage: params("Robins Blog: {language} posts only"),
});
const locale = parseLocale(Astro.params.locale);
const { translations } = Astro.props;
let base = `${import.meta.env.SITE || ""}${import.meta.env.BASE_URL || ""}`;
base = base.endsWith("/") ? base : `${base}/`;
---

<head>
  <meta charset="utf-8" />
  <slot name="meta" />
  <meta name="viewport" content="width=device-width" />
  <script is:inline id="analytics" defer data-domain="r.obin.ch" src="https://analytics.obin.ch/js/script.js"></script>

  <link rel="alternate" hreflang="x-default" href={base} />
  <link rel="alternate" hreflang={getFullLocale(locale)} href={Astro.url.href} />
  <meta property="og:locale" content={getFullLocale(locale).replace(`-`, `_`)} />
  {
    Object.entries(translations || {})
      .filter(([l]) => l !== locale)
      .map(([locale, path]) => (
        <Fragment>
          <link rel="alternate" hreflang={getFullLocale(locale)} href={new URL(path, Astro.url).href} />
          <meta property="og:locale:alternate" content={getFullLocale(locale).replace(`-`, `_`)} />
        </Fragment>
      ))
  }
  <link rel="alternate" type="application/rss+xml" title={messages.title} href={resolvePath("rss.xml")} />
  {
    localeSlugs.map((l) => {
      return (
        <link
          rel="alternate"
          type="application/rss+xml"
          title={messages.filteredByLanguage({ language: getNameFromLocale(l) || l })}
          href={resolvePath(`rss-${l}.xml`)}
        />
      );
    })
  }
  <link rel="sitemap" href={resolvePath("sitemap-index.xml")} />
  <ClientRouter />
</head>
