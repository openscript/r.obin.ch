---
import { useI18n } from "astro-nanostores-i18n:runtime";

const messages = useI18n("components.search", {
  searching: "Searching...",
  placeholder: "Type to search...",
});
const bundle = `/pagefind/pagefind.js`;
---

<script>
  async function initializeSearch(bundle: string) {
    if (globalThis.pagefind) return;
    globalThis.pagefind = await import(/* @vite-ignore */ bundle);
    globalThis.pagefind?.init();
  }

  function render(results: PagefindSearchFragment[]) {
    const resultsList = document.querySelector(".results") as HTMLUListElement;
    resultsList.innerHTML = "";
    if (results.length === 0) {
      resultsList.textContent = resultsList.dataset.loadingText || "Loading...";
      return;
    }
    results.forEach((result) => {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.innerHTML = `<strong>${result.meta.title}: </strong>${result.excerpt}`;
      a.href = result.url;
      li.appendChild(a);
      resultsList.appendChild(li);
    });
  }

  async function search(query: string) {
    if (!globalThis.pagefind) return;
    const records = await globalThis.pagefind.debouncedSearch(query);

    render([]);

    if (records?.results) {
      render(await Promise.all(records.results.slice(0, 5).map((r) => r.data())));
    } else {
      render([]);
    }
  }

  async function initialize() {
    const searchWrapper = document.querySelector("[data-search-ui]") as HTMLDivElement;
    const searchInput = document.querySelector("input[type=search]") as HTMLInputElement;
    if (!searchInput || !searchWrapper || !searchWrapper.dataset.searchBundle) return;

    initializeSearch(searchWrapper.dataset.searchBundle);

    searchInput.addEventListener("input", () => {
      search(searchInput.value);
    });

    searchWrapper.addEventListener("focusin", (event) => {
      if (event.target === searchInput) search(searchInput.value);
      document.body.classList.add("search-active");
    });

    searchWrapper.addEventListener("focusout", () => {
      document.body.classList.remove("search-active");
    });
  }

  document.addEventListener("astro:page-load", initialize);
  document.addEventListener("DOMContentLoaded", initialize);
</script>

<div class="search" data-search-ui data-search-bundle={bundle}>
  <input type="search" placeholder={messages.placeholder} />
  <ul class="results" data-loading-text={messages.searching}>{messages.searching}</ul>
</div>

<style>
  .search {
    display: flex;
    position: relative;
    width: calc(100% - 2 * var(--gap));
    justify-content: center;

    input {
      width: calc(100% - 2 * var(--gap));
      background-color: var(--color-primary);
      font-size: 1.2rem;
      padding: 0.656rem var(--gap);
      border: var(--border-width) solid var(--color-primary-120);
      border-radius: var(--border-radius);
      color: var(--color-white);
      transition: var(--transition-duration);
    }

    input::placeholder {
      color: var(--color-primary-120);
    }

    input:focus,
    input:hover {
      border-color: var(--color-white);
      outline: none;
    }

    input:not(:focus)::-webkit-search-cancel-button {
      display: none;
    }

    input::-webkit-search-cancel-button {
      -webkit-appearance: none;
      appearance: none;
    }

    input::-webkit-search-cancel-button {
      height: 1.5rem;
      width: 1.5rem;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E")
        no-repeat center;
      background-size: 1.5rem 1.5rem;
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition-duration);
    }
  }

  .results {
    display: none;
    position: absolute;
    list-style: none;
    z-index: 10;
    margin: 0 1rem;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--color-primary-105);
    font-size: 1.2rem;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }

  .search:focus-within input:not(:placeholder-shown) + .results,
  .results:focus-within {
    display: flex;
  }
</style>
